<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miniscript Playground</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
  </head>
  <body>
    
    
    <!-- Contenedor envoltorio -->
    <div class="main-wrapper">
      
      <!-- Contenido superior -->
  <div class="top-panel">
        <div class="top-panel-inner">
          <a href="https://github.com/unlock-blocks/Miniscript" target="_blank" rel="noopener" title="Repositorio de GitHub de Bitcoin Miniscript">
            <img src="btcLogo.png" alt="Repositorio de GitHub de Bitcoin Miniscript" title="Repositorio de GitHub de Bitcoin Miniscript" class="top-panel-logo">
          </a>
          <h1 class="top-panel-title">Miniscript Playground</h1>
          <a href="https://unlock-blocks.github.io/Miniscript/" target="_blank" rel="noopener" class="top-panel-right" title="Abrir Miniscript Playground en nueva pestaña">🛝</a>
        </div>
      </div>

      <div class="container">

        <!-- Columna izquierda: Menú de pólizas -->
  <div class="menu">
          <h2><span>🗂️</span> Pólizas </h2>

          
          <div class="button-row">
            <button class="app-button" title="Herencia digital" onclick="activarPoliza(this, 'htmls/herencia.html')"><span>🧬</span> Herencia digital </button>
          </div>
          <div class="button-row">
            <button class="app-button" title="Autocustodia programada" onclick="activarPoliza(this, 'htmls/autocustodia.html')"><span>🤖</span> Autocustodia programada </button>
          </div>
          <div class="button-row">
            <button class="app-button" title="Bóveda de seguridad" onclick="activarPoliza(this, 'htmls/boveda.html')"><span>🏦</span> Bóveda de seguridad</button>
          </div>
          <!-- Contenedor para la descripción de la póliza (el árbol) -->
          <div id="policy-description" class="policy-description"></div>
        </div>
      
          <!-- Columna derecha: Contenido del proyecto -->
          <div class="content">
            <!-- El contenido de la póliza (botones, etc.) se cargará aquí -->
            <div id="policy-content"></div>
            <!-- La consola de salida ÚNICA para todos los scripts va aquí -->
            <div id="output-console" class="output-console"></div>
          </div>

      </div>
    </div>

    <script>

      // Función de ayuda para eliminar el tabulado de un texto multilínea.
      function dedent(text) {
        const lines = text.split('\n');
        let firstLineIndex = -1;

        // Encontrar la primera línea con contenido
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].trim() !== '') {
            firstLineIndex = i;
            break;
          }
        }

        // Si no hay contenido, devolver cadena vacía
        if (firstLineIndex === -1) return '';

        // Calcular la indentación de la primera línea con contenido
        const indentMatch = lines[firstLineIndex].match(/^\s*/);
        const indent = indentMatch ? indentMatch[0] : '';

        // Eliminar la indentación de todas las líneas y reconstruir el texto
        return lines.map(line => line.startsWith(indent) ? line.substring(indent.length) : line).join('\n').trim();
      }

      // Función para activar el botón del menú y cargar la póliza correspondiente
      function activarPoliza(button, url) {
        // Quitar la clase 'active' de todos los botones del menú
        document.querySelectorAll('.menu .app-button').forEach(btn => btn.classList.remove('active'));
        // Añadir la clase 'active' al botón pulsado
        button.classList.add('active');
        // Forzar la recarga de la póliza aunque sea la misma
        loadProjectByURL(url);
      }

      // Variable global para almacenar el proyecto actual cargado y evitar recargas innecesarias
      let proyectoActual = null;

      // Función para cargar el contenido de la póliza seleccionada
      function loadProjectByURL(proyectoUrl) {
        const scriptName = proyectoUrl.split('/').pop().split('.')[0];
        // Si ya está cargada la misma póliza, no recargar
        if (proyectoActual === scriptName) return;
        proyectoActual = scriptName;

        // Limpiar la consola de salida al cambiar de póliza
        document.getElementById('output-console').innerHTML = '';

        // Cargar el contenido HTML de la póliza seleccionada 
        fetch(proyectoUrl)
          .then(response => {
            if (!response.ok) {
              throw new Error('Error al cargar el contenido: ' + response.statusText);
            }
            return response.text();
          })
          .then(html => {
            // Insertar el contenido en el div de la derecha
            document.getElementById('policy-content').innerHTML = html;

            // Eliminar el script de la póliza cargada anteriormente para evitar conflictos.
            const oldScript = document.querySelector('script[data-policy-script]');
            if (oldScript) {
              oldScript.remove();
            }

            // Crear y añadir el nuevo script para la póliza actual.
            const script = document.createElement('script');
            // Se añade un timestamp para forzar al navegador a re-ejecutar el script siempre.
            script.src = `./dist/${scriptName}.bundle.js?v=${new Date().getTime()}`;
            // Se añade un atributo para poder encontrarlo y borrarlo la próxima vez.
            script.setAttribute('data-policy-script', 'true');
            document.body.appendChild(script);


            // Mostrar el árbol de emojis según la póliza seleccionada
            if (scriptName === 'autocustodia') {
              document.getElementById('policy-description').innerHTML = dedent(`
                <pre><span><span style="font-size:1.5em;">🤖</span><span style="font-size:1.2em;"><b> Autocustodia programada </b></span></span>
                │    
                │
                ├─ <span>🗓️</span> <b>Diario: <span>🔑🔑 ➡️ 🔐🔐🔐</span> </b>
                │  │ 
                │  ├─ <span>🔑</span> Llave principal 
                │  │ 
                │  ├─ <span>🔑</span> Llave secundaria
                │  │ 
                │  └─ <span>🗝️</span> Llave del custodio
                │    
                │    
                ├─ <span>🛡️</span><b> Recuperación <span>🕒</span> <label for="blocks-recovery-autocustodia" style="display:inline-flex;align-items:center;gap:6px;"> <input type="number" id="blocks-recovery-autocustodia" min="1" value="3" style="width:2.2rem;padding:2px;"/>bloques</label>: <span>🔑 ➡️ 🔐🔐</span> </b>
                │  │ 
                │  ├─ <span>🔑</span> Llave de respaldo principal
                │  │ 
                │  └─ <span>🔑</span> Llave de respaldo secundaria
                │    
                │    
                └─ <span>🚨</span><b> Emergencia <span>⏰</span> <label for="blocks-emergency-autocustodia" style="display:inline-flex;align-items:center;gap:6px;"> <input type="number" id="blocks-emergency-autocustodia" min="1" value="5" style="width:2.2rem;padding:2px;"/>bloques</label>: <span>🗝️ ➡️ 🔐</span> </b>
                   │
                   └─ <span>🗝️</span> Llave de apertura por perdida
                </pre>`);
            } else if (scriptName === 'boveda') { 
              document.getElementById('policy-description').innerHTML = dedent(`
                <pre><span><span style="font-size:1.5em;">🏦</span><span style="font-size:1.2em;"><b> Bóveda de seguridad </b></span></span>
                │
                │
                ├─ <span>🔧</span> <b>Apertura forzada <span>🕒</span> <label for="blocks-retardada" style="display:inline-flex;align-items:center;gap:6px;"> <input type="number" id="blocks-retardada" min="1" value="3" style="width:2.2rem;padding:2px;"/>bloques</label>: <span>🔑 ➡️ 🔐</span> </b>
                │  │ 
                │  └─ <span>🔑</span> Llave de apertura retardada
                │
                │
                └─ <span>🆘</span> <b>Botón del pánico: <span>🗝️ ➡️ 🔐</span> </b>
                   │
                   └─ <span>🗝️</span> Llave de apertura inmediata
                </pre>`);
            } else if (scriptName === 'herencia') {
              document.getElementById('policy-description').innerHTML = dedent(`
                <pre><span><span style="font-size:1.5em;">🧬</span><span style="font-size:1.2em;"><b> Herencia digital </b></span></span>
                │
                │
                ├─ <span>🧓🏻</span> <b>Directo: <span>🔑 ➡️ 🔐</span> </b>
                │  │ 
                │  └─ <span>🔑</span> Llave del progenitor
                │
                │
                ├─ <span>🧑🏻👨🏻</span> <b>Herencia <span>🕒</span> <label for="blocks-herencia" style="display:inline-flex;align-items:center;gap:6px;"> <input type="number" id="blocks-herencia" min="1" value="3" style="width:2.2rem;padding:2px;"/>bloques</label>: <span>🔑🔑 ➡️ 🔐🔐</span> </b>
                │  │ 
                │  ├─ <span>🔑</span> Llave de la heredera
                │  │ 
                │  └─ <span>🔑</span> Llave del heredero
                │
                │
                └─ <span>👤</span> <b>Disputa <span>⏰</span> <label for="blocks-disputa" style="display:inline-flex;align-items:center;gap:6px;"> <input type="number" id="blocks-disputa" min="1" value="5" style="width:2.2rem;padding:2px;"/>bloques</label>: <span>🗝️ ➡️ 🔐</span> </b>
                   │ 
                   └─ <span>🗝️</span> Llave del abogado
                </pre>`);
            } else {
              document.getElementById('policy-description').innerHTML = '';
            }
          })

          .catch(error => {
            console.error('Error:', error);
            document.getElementById('content').innerHTML = `<p>Error al cargar el proyecto: ${error.message}</p>`;
          });
      }

      // Autocargar la primera póliza al iniciar la página
      document.addEventListener('DOMContentLoaded', () => {
        const firstButton = document.querySelector('.menu .app-button');
        if (firstButton) {
          activarPoliza(firstButton, 'htmls/herencia.html');
        }
      });
    </script>

  </body>
</html>